<div class="viewer-shell">
  <aside class="viewer-sidebar">
    <div class="sidebar-header">
      <p class="eyebrow">Data</p>
      <h2>CityJSON Explorer</h2>
      <p>Load a file or use the bundled sample to jump right in.</p>
    </div>

    <label class="file-picker">
      <input type="file" accept=".json,.city.json,.cityjson" (change)="onFileSelected($event)" />
      <span>Upload CityJSON</span>
    </label>
    <button class="ghost" type="button" (click)="reloadDefaultModel()">Load Sample Model</button>

    <!-- Backend Actions -->
    <div class="backend-actions">
      <p class="eyebrow">Backend</p>
      <div class="button-row">
        <button class="ghost" type="button" (click)="saveModelToBackend()" [disabled]="isSaving() || !cityjson()">
          {{ isSaving() ? 'Saving...' : 'Save Model' }}
        </button>
        <button class="ghost" type="button" (click)="toggleModelList()">
          {{ showModelList() ? 'Hide List' : 'Load from Server' }}
        </button>
      </div>

      @if (currentRecordId()) {
        <div class="status selection">
          Backend ID: <strong>{{ currentRecordId() }}</strong>
        </div>
      }
    </div>

    <!-- Saved Models List -->
    @if (showModelList()) {
      <div class="model-list">
        <p class="eyebrow">Saved Models</p>
        @if (savedModels().length === 0) {
          <p class="tree-placeholder">No saved models found.</p>
        }
        @for (model of savedModels(); track model.id) {
          <button class="model-item" type="button" (click)="loadModelFromBackend(model)">
            <span class="model-name">{{ model.name }}</span>
            <span class="model-id">ID: {{ model.id }}</span>
          </button>
        }
      </div>
    }

    @if (isLoading()) {
      <div class="status">Loading model...</div>
    }

    @if (loadError()) {
      <div class="status error">{{ loadError() }}</div>
    }

    @if (saveStatus()) {
      <div class="status" [class.error]="saveStatus()!.startsWith('Failed') || saveStatus()!.startsWith('Save the model')">
        {{ saveStatus() }}
      </div>
    }

    @if (selectedObjectId()) {
      <div class="status selection">
        Selected: <strong>{{ selectedObjectId() }}</strong>
      </div>
    }

    <div class="tree-wrapper">
      @if (cityjson() || cityjson() === null) {
        <app-cityobjects-tree
          [cityjson]="cityjson() ?? null"
          (selectObject)="onSelectionChange($event)">
        </app-cityobjects-tree>
      } @else {
        <p class="tree-placeholder">
          The City Objects tree will appear here after a file is loaded.
        </p>
      }
    </div>
  </aside>

  <section class="viewer-panel">
    <div class="viewer-toolbar">
      <div>
        <p class="eyebrow">Active Viewer</p>
        <h1>{{ activeViewer() === 'ninja' ? 'Ninja' : 'Three.js' }} renderer</h1>
      </div>
      <div class="viewer-switch">
        <button
          type="button"
          [class.active]="activeViewer() === 'ninja'"
          (click)="switchViewer('ninja')">
          Ninja
        </button>
        <button
          type="button"
          [class.active]="activeViewer() === 'threejs'"
          (click)="switchViewer('threejs')">
          Three.js
        </button>
      </div>
    </div>

    <div class="viewer-stage">

      @if (activeViewer() === 'ninja') {
        <app-ninja-viewer
          [focusObjectId]="selectedObjectId()"
          (objectSelected)="onSelectionChange($event)"
          (apartmentCreated)="onApartmentCreated($event)">
        </app-ninja-viewer>
      }

      @if (activeViewer() === 'threejs') {
        <p class="stage-placeholder">Three.js viewer coming soon...</p>
      }

      @if (!cityjson() && !isLoading()) {
        <div class="stage-placeholder">
          <h3>Awaiting CityJSON</h3>
          <p>Upload a CityJSON file or load the sample dataset to start exploring.</p>
        </div>
      }

      @if (isLoading()) {
        <div class="stage-placeholder loading">
          <h3>Preparing scene...</h3>
          <p>This usually takes only a few seconds.</p>
        </div>
      }

    </div>
  </section>
</div>
