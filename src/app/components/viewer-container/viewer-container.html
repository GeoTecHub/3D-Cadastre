<div class="app-shell">
  <!-- Header -->
  <header class="app-header">
    <div class="header-brand">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <!-- Building base -->
          <path d="M3 21h18"/>
          <path d="M5 21V7l7-4 7 4v14"/>
          <!-- Windows/floors -->
          <rect x="9" y="9" width="2" height="2"/>
          <rect x="13" y="9" width="2" height="2"/>
          <rect x="9" y="13" width="2" height="2"/>
          <rect x="13" y="13" width="2" height="2"/>
          <!-- Door -->
          <path d="M10 21v-4h4v4"/>
        </svg>
      </div>
      <div class="brand-text">
        <h1>3D Cadastre Nexus</h1>
        <span class="version">v1.0</span>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <label class="toolbar-btn primary">
        <input type="file" accept=".json,.city.json,.cityjson" (change)="onFileSelected($event)" hidden />
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <span>Import CityJSON</span>
      </label>

      <div class="toolbar-divider"></div>

      <div class="toolbar-dropdown-wrapper">
        <button class="toolbar-btn icon-only" (click)="toggleModelList()" title="Load from Server">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <ellipse cx="12" cy="5" rx="9" ry="3"/>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
          </svg>
        </button>

        @if (showModelList()) {
          <div class="model-list-dropdown">
            <div class="dropdown-header">
              <h4>Saved Models</h4>
              <button class="close-btn" (click)="showModelList.set(false)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="dropdown-content">
              @if (savedModels().length === 0) {
                <p class="empty-message">No saved models found</p>
              }
              @for (model of savedModels(); track model.id) {
                <button class="model-item" (click)="loadModelFromBackend(model)">
                  <span class="model-name">{{ model.name }}</span>
                  <span class="model-id">ID: {{ model.id }}</span>
                </button>
              }
            </div>
          </div>
        }
      </div>

      <button class="toolbar-btn icon-only" [class.active]="showOsmMap()" (click)="toggleOsmMap()" [disabled]="!cityjson()" title="Toggle OSM Map">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="2" y1="12" x2="22" y2="12"/>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
        </svg>
      </button>

      <button class="toolbar-btn icon-only" [class.active]="parcelsData()" (click)="loadSampleParcels()" [disabled]="!cityjson()" title="Load Sample Parcels">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
          <line x1="8" y1="2" x2="8" y2="18"/>
          <line x1="16" y1="6" x2="16" y2="22"/>
        </svg>
      </button>

      <button class="toolbar-btn icon-only" (click)="reloadDefaultModel()" title="Load Sample">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
      </button>
    </div>

    <!-- Status Indicators -->
    <div class="header-status">
      @if (currentRecordId()) {
        <span class="status-badge success">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          ID: {{ currentRecordId() }}
        </span>
      }
      @if (saveStatus()) {
        <span class="status-badge" [class.error]="saveStatus()!.includes('Failed')">
          {{ saveStatus() }}
        </span>
      }
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Viewer Area -->
    <section class="viewer-area">
      <div class="viewer-wrapper">
        @if (activeViewer() === 'ninja') {
          <app-ninja-viewer
            [focusObjectId]="selectedObjectId()"
            [showOsmMap]="showOsmMap()"
            [parcelsData]="parcelsData()"
            [parcelsEpsg]="parcelsEpsg()"
            (objectSelected)="onSelectionChange($event)"
            (apartmentCreated)="onApartmentCreated($event)"
            (osmMapStatus)="onOsmMapStatus($event)"
            (parcelSelected)="onParcelSelected($event)">
          </app-ninja-viewer>
        }

        @if (activeViewer() === 'threejs') {
          <div class="viewer-placeholder">
            <h3>Three.js Viewer</h3>
            <p>Coming soon...</p>
          </div>
        }

        @if (osmMapStatusMsg()) {
          <div class="osm-status-bar" [class.error]="osmMapStatusMsg()!.includes('No CRS') || osmMapStatusMsg()!.includes('Failed')">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="2" y1="12" x2="22" y2="12"/>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
            </svg>
            <span>{{ osmMapStatusMsg() }}</span>
          </div>
        }

        @if (!cityjson() && !isLoading()) {
          <div class="viewer-overlay">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
            <h3>Welcome to 3D Cadastre Nexus</h3>
            <p>Import a CityJSON file to begin exploring 3D cadastral data</p>
            <label class="upload-btn">
              <input type="file" accept=".json,.city.json,.cityjson" (change)="onFileSelected($event)" hidden />
              <span>Import CityJSON</span>
            </label>
          </div>
        }

        @if (isLoading()) {
          <div class="viewer-overlay loading">
            <div class="loader"></div>
            <h3>Loading Model</h3>
            <p>Preparing the 3D scene...</p>
          </div>
        }
      </div>
    </section>

    <!-- Right Sidebar - Tabbed Info Panel -->
    <aside class="sidebar right-sidebar" [style.width.px]="sidebarWidth()">
      <div class="resize-handle" (mousedown)="onResizeStart($event)"></div>

      <!-- Tab Bar -->
      <div class="sidebar-tab-bar">
        <button class="sidebar-tab" [class.active]="activeSidebarTab() === 'building'" (click)="switchSidebarTab('building')">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 21h18"/>
            <path d="M5 21V7l7-4 7 4v14"/>
            <rect x="9" y="9" width="2" height="2"/>
            <rect x="13" y="9" width="2" height="2"/>
            <rect x="9" y="13" width="2" height="2"/>
            <rect x="13" y="13" width="2" height="2"/>
          </svg>
          <span>Building</span>
        </button>
        <button class="sidebar-tab" [class.active]="activeSidebarTab() === 'land'" (click)="switchSidebarTab('land')">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <span>Land</span>
        </button>
      </div>

      <!-- Building Tab Content -->
      @if (activeSidebarTab() === 'building') {
        <div class="sidebar-tab-content">
          <app-building-info-panel
            [buildingInfo]="buildingInfo()"
            [selectedUnitId]="selectedObjectId()"
            [modelLoaded]="modelLoaded()"
            [availableRooms]="availableRooms()"
            [assignedRoomMap]="assignedRoomMap()"
            [pendingRoomSelection]="pendingRoomSelection()"
            (unitSelected)="onUnitSelected($event)"
            (explodeViewRequested)="onExplodeViewRequested()"
            (summaryChanged)="onSummaryChanged($event)"
            (rrrChanged)="onRRRChanged($event)"
            (unitsChanged)="onUnitsChanged($event)"
            (spatialChanged)="onSpatialChanged($event)"
            (physicalChanged)="onPhysicalChanged($event)"
            (relationshipsChanged)="onRelationshipsChanged($event)"
            (metadataChanged)="onMetadataChanged($event)"
            (saveModelRequested)="onSaveModelRequested()"
            (saveBuildingRequested)="onSaveBuildingRequested($event)"
            (deleteBuildingRequested)="onDeleteBuildingRequested()"
            (startRoomSelection)="onStartRoomSelection($event)"
            (finishRoomSelection)="onFinishRoomSelection($event)"
            (cancelRoomSelection)="onCancelRoomSelection()"
            (highlightRooms)="onHighlightRooms($event)">
          </app-building-info-panel>
        </div>
      }

      <!-- Land Tab Content -->
      @if (activeSidebarTab() === 'land') {
        <div class="sidebar-tab-content">
          <app-land-info-panel
            [parcelInfo]="parcelInfo()"
            (identificationChanged)="onParcelIdentificationChanged($event)"
            (spatialChanged)="onParcelSpatialChanged($event)"
            (physicalChanged)="onParcelPhysicalChanged($event)"
            (zoningChanged)="onParcelZoningChanged($event)"
            (rrrChanged)="onParcelRRRChanged($event)"
            (valuationChanged)="onParcelValuationChanged($event)"
            (relationshipsChanged)="onParcelRelationshipsChanged($event)"
            (metadataChanged)="onParcelMetadataChanged($event)"
            (saveParcelRequested)="onSaveParcelRequested($event)"
            (deleteParcelRequested)="onDeleteParcelRequested()"
            (newParcelRequested)="onNewParcelRequested($event)">
          </app-land-info-panel>
        </div>
      }
    </aside>
  </div>

  <!-- Save Model Dialog -->
  <app-save-model-dialog
    [isOpen]="showSaveModelDialog()"
    [buildingInfo]="buildingInfo()"
    (dialogClose)="onSaveModelDialogClose($event)">
  </app-save-model-dialog>

  <!-- Create Apartment Dialog -->
  <app-create-apartment-dialog
    [isOpen]="showCreateApartmentDialog()"
    [buildingInfo]="buildingInfo()"
    [selectedRooms]="selectedRoomsForApartment()"
    (dialogClose)="onCreateApartmentDialogClose($event)">
  </app-create-apartment-dialog>
</div>
