<div class="app-shell">
  <!-- Header -->
  <header class="app-header">
    <div class="header-brand">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <!-- Building base -->
          <path d="M3 21h18"/>
          <path d="M5 21V7l7-4 7 4v14"/>
          <!-- Windows/floors -->
          <rect x="9" y="9" width="2" height="2"/>
          <rect x="13" y="9" width="2" height="2"/>
          <rect x="9" y="13" width="2" height="2"/>
          <rect x="13" y="13" width="2" height="2"/>
          <!-- Door -->
          <path d="M10 21v-4h4v4"/>
        </svg>
      </div>
      <div class="brand-text">
        <h1>3D Cadastre Nexus</h1>
        <span class="version">v1.0</span>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <label class="toolbar-btn primary">
        <input type="file" accept=".json,.city.json,.cityjson" (change)="onFileSelected($event)" hidden />
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <span>Import CityJSON</span>
      </label>

      <button class="toolbar-btn" (click)="openSaveModelDialog()" [disabled]="isSaving() || !cityjson()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
        <span>{{ isSaving() ? 'Saving...' : 'Save Model' }}</span>
      </button>

      <button class="toolbar-btn" (click)="startApartmentCreation()" [disabled]="!cityjson()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
        <span>Create Apartment</span>
      </button>

      <div class="toolbar-divider"></div>

      <div class="toolbar-dropdown-wrapper">
        <button class="toolbar-btn icon-only" (click)="toggleModelList()" title="Load from Server">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <ellipse cx="12" cy="5" rx="9" ry="3"/>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
          </svg>
        </button>

        @if (showModelList()) {
          <div class="model-list-dropdown">
            <div class="dropdown-header">
              <h4>Saved Models</h4>
              <button class="close-btn" (click)="showModelList.set(false)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="dropdown-content">
              @if (savedModels().length === 0) {
                <p class="empty-message">No saved models found</p>
              }
              @for (model of savedModels(); track model.id) {
                <button class="model-item" (click)="loadModelFromBackend(model)">
                  <span class="model-name">{{ model.name }}</span>
                  <span class="model-id">ID: {{ model.id }}</span>
                </button>
              }
            </div>
          </div>
        }
      </div>

      <button class="toolbar-btn icon-only" (click)="reloadDefaultModel()" title="Load Sample">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
      </button>
    </div>

    <!-- Status Indicators -->
    <div class="header-status">
      @if (currentRecordId()) {
        <span class="status-badge success">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          ID: {{ currentRecordId() }}
        </span>
      }
      @if (saveStatus()) {
        <span class="status-badge" [class.error]="saveStatus()!.includes('Failed')">
          {{ saveStatus() }}
        </span>
      }
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Viewer Area -->
    <section class="viewer-area">
      <div class="viewer-wrapper">
        @if (activeViewer() === 'ninja') {
          <app-ninja-viewer
            [focusObjectId]="selectedObjectId()"
            (objectSelected)="onSelectionChange($event)"
            (apartmentCreated)="onApartmentCreated($event)">
          </app-ninja-viewer>
        }

        @if (activeViewer() === 'threejs') {
          <div class="viewer-placeholder">
            <h3>Three.js Viewer</h3>
            <p>Coming soon...</p>
          </div>
        }

        @if (!cityjson() && !isLoading()) {
          <div class="viewer-overlay">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
            <h3>Welcome to 3D Cadastre Nexus</h3>
            <p>Import a CityJSON file to begin exploring 3D cadastral data</p>
            <label class="upload-btn">
              <input type="file" accept=".json,.city.json,.cityjson" (change)="onFileSelected($event)" hidden />
              <span>Import CityJSON</span>
            </label>
          </div>
        }

        @if (isLoading()) {
          <div class="viewer-overlay loading">
            <div class="loader"></div>
            <h3>Loading Model</h3>
            <p>Preparing the 3D scene...</p>
          </div>
        }
      </div>
    </section>

    <!-- Right Sidebar - Building Info Panel -->
    <aside class="sidebar right-sidebar">
      <app-building-info-panel
        [buildingInfo]="buildingInfo()"
        [selectedUnitId]="selectedObjectId()"
        (unitSelected)="onUnitSelected($event)"
        (explodeViewRequested)="onExplodeViewRequested()">
      </app-building-info-panel>
    </aside>
  </div>

  <!-- Save Model Dialog -->
  <app-save-model-dialog
    [isOpen]="showSaveModelDialog()"
    [buildingInfo]="buildingInfo()"
    (dialogClose)="onSaveModelDialogClose($event)">
  </app-save-model-dialog>

  <!-- Create Apartment Dialog -->
  <app-create-apartment-dialog
    [isOpen]="showCreateApartmentDialog()"
    [buildingInfo]="buildingInfo()"
    [selectedRooms]="selectedRoomsForApartment()"
    (dialogClose)="onCreateApartmentDialogClose($event)">
  </app-create-apartment-dialog>
</div>
