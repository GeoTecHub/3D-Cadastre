<div class="info-panel">
  <div class="panel-header">
    <h2>Building Details</h2>
  </div>

  @if (!hasBuilding()) {
    <div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 21h18M3 7v14M21 7v14M6 11h.01M6 15h.01M6 19h.01M10 11h.01M10 15h.01M10 19h.01M14 11h.01M14 15h.01M14 19h.01M18 11h.01M18 15h.01M18 19h.01M9 3h6l3 4H6l3-4z"/>
      </svg>
      <p>Select a building to view details</p>
    </div>
  } @else {
    <div class="panel-content">
      <!-- Summary & Administrative Section -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('summary')"
          (click)="toggleSection('summary')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
          </span>
          <span class="section-title">Summary & Administrative</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('summary')) {
          <div class="section-content">
            <table class="info-table editable-table">
              <!-- buildingId: String, Editable -->
              <tr>
                <td class="label">Building ID</td>
                <td class="value">
                  <input
                    type="text"
                    class="field-input"
                    [ngModel]="buildingInfo()?.summary?.buildingId ?? ''"
                    (ngModelChange)="onSummaryFieldChange('buildingId', $event)"
                    placeholder="e.g., B-8294-X"
                  />
                </td>
              </tr>
              <!-- legalStatus: Enum, Dropdown -->
              <tr>
                <td class="label">Legal Status</td>
                <td class="value">
                  <select
                    class="field-select"
                    [ngModel]="buildingInfo()?.summary?.legalStatus ?? ''"
                    (ngModelChange)="onSummaryFieldChange('legalStatus', $event)">
                    @for (opt of legalStatusOptions; track opt) {
                      <option [value]="opt">{{ legalStatusDisplayMap[opt] }}</option>
                    }
                  </select>
                </td>
              </tr>
              <!-- address: String, Editable, max 255 -->
              <tr>
                <td class="label">Address</td>
                <td class="value">
                  <input
                    type="text"
                    class="field-input"
                    [ngModel]="buildingInfo()?.summary?.address ?? ''"
                    (ngModelChange)="onSummaryFieldChange('address', $event)"
                    placeholder="Full physical address"
                    maxlength="255"
                  />
                </td>
              </tr>
              <!-- primaryUse: Enum, Dropdown -->
              <tr>
                <td class="label">Primary Use</td>
                <td class="value">
                  <select
                    class="field-select"
                    [ngModel]="buildingInfo()?.summary?.primaryUse ?? ''"
                    (ngModelChange)="onSummaryFieldChange('primaryUse', $event)">
                    @for (opt of primaryUseOptions; track opt) {
                      <option [value]="opt">{{ primaryUseDisplayMap[opt] }}</option>
                    }
                  </select>
                </td>
              </tr>
              <!-- cadastralRef: String, Editable link -->
              <tr>
                <td class="label">Cadastral Ref.</td>
                <td class="value">
                  <input
                    type="text"
                    class="field-input cadastral-link-input"
                    [ngModel]="buildingInfo()?.summary?.cadastralRef ?? ''"
                    (ngModelChange)="onSummaryFieldChange('cadastralRef', $event)"
                    placeholder="e.g., Parcel 123"
                  />
                </td>
              </tr>
              <!-- floorCount: Integer, Editable -->
              <tr>
                <td class="label">Floor Count</td>
                <td class="value">
                  <input
                    type="number"
                    class="field-input"
                    [ngModel]="buildingInfo()?.summary?.floorCount ?? 0"
                    (ngModelChange)="onSummaryFieldChange('floorCount', $event)"
                    min="0"
                  />
                </td>
              </tr>
              <!-- registrationDate: Date (ISO 8601), Editable -->
              <tr>
                <td class="label">Registration Date</td>
                <td class="value">
                  <input
                    type="date"
                    class="field-input"
                    [ngModel]="buildingInfo()?.summary?.registrationDate ?? ''"
                    (ngModelChange)="onSummaryFieldChange('registrationDate', $event)"
                  />
                </td>
              </tr>
            </table>
          </div>
        }
      </div>

      <!-- Spatial/Geometric (3D) Section -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('spatial')"
          (click)="toggleSection('spatial')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
          </span>
          <span class="section-title">Spatial/Geometric (3D)</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('spatial')) {
          <div class="section-content">
            <table class="info-table">
              <tr>
                <td class="label">Footprint</td>
                <td class="value">{{ buildingInfo()?.spatial?.footprint || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">Solid Geometry</td>
                <td class="value">{{ buildingInfo()?.spatial?.solidGeometry || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">Bounded By</td>
                <td class="value">
                  @if (buildingInfo()?.spatial?.boundedBy?.length) {
                    <span class="tag-list">
                      @for (surface of buildingInfo()?.spatial?.boundedBy; track surface) {
                        <span class="tag">{{ surface }}</span>
                      }
                    </span>
                  } @else {
                    N/A
                  }
                </td>
              </tr>
              <tr>
                <td class="label">Height Above Ground</td>
                <td class="value">{{ formatHeight(buildingInfo()?.spatial?.heightAboveGround) }}</td>
              </tr>
              <tr>
                <td class="label">Volume</td>
                <td class="value">{{ formatVolume(buildingInfo()?.spatial?.volume) }}</td>
              </tr>
              <tr>
                <td class="label">Surface Area</td>
                <td class="value">{{ formatArea(buildingInfo()?.spatial?.surfaceArea) }}</td>
              </tr>
              <tr>
                <td class="label">Coordinate System</td>
                <td class="value">{{ buildingInfo()?.spatial?.coordinateSystem || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">LoD Level</td>
                <td class="value">
                  <span class="badge badge-info">{{ buildingInfo()?.spatial?.lodLevel || 'N/A' }}</span>
                </td>
              </tr>
            </table>
          </div>
        }
      </div>

      <!-- Rights, Restrictions & Responsibilities (RRR) Section -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('rrr')"
          (click)="toggleSection('rrr')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
          </span>
          <span class="section-title">Rights, Restrictions & Responsibilities (RRR)</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('rrr')) {
          <div class="section-content rrr-section">

            <!-- Tabs: Overview / Ownership -->
            <div class="tab-bar">
              <button
                class="tab-btn"
                [class.active]="activeRRRTab() === 'overview'"
                (click)="setRRRTab('overview')">
                Owned rview
              </button>
              <button
                class="tab-btn"
                [class.active]="activeRRRTab() === 'ownership'"
                (click)="setRRRTab('ownership')">
                Ownership
              </button>
            </div>

            <!-- ═══ Overview Tab ═══ -->
            @if (activeRRRTab() === 'overview') {
              <div class="tab-content">
                @if (buildingInfo()?.rrr?.entries?.length) {
                  @for (entry of buildingInfo()!.rrr.entries; track entry.rrrId; let i = $index) {
                    <div class="rrr-overview-card" [class.expanded]="expandedRRRId() === entry.rrrId">
                      <!-- Summary row -->
                      <button class="rrr-overview-header" (click)="toggleRRRExpand(entry.rrrId)">
                        <span class="rrr-holder">{{ entry.holder }}</span>
                        <span class="rrr-type-badge">{{ rightTypeDisplayMap[entry.type] }}</span>
                        <span class="rrr-share">{{ entry.share }}%</span>
                        <span class="rrr-chevron">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                          </svg>
                        </span>
                      </button>

                      <!-- Expanded detail -->
                      @if (expandedRRRId() === entry.rrrId) {
                        <div class="rrr-detail-panel">
                          <!-- Restrictions linked to this holder -->
                          <div class="rrr-sub-section">
                            <div class="rrr-sub-header">
                              <span class="rrr-sub-title">Restrictions</span>
                              <button class="rrr-add-btn" (click)="addRestriction(i)">+ Add</button>
                            </div>
                            @if (entry.restrictions.length) {
                              @for (r of entry.restrictions; track r.type; let ri = $index) {
                                <div class="rrr-sub-row">
                                  <select
                                    class="field-select rrr-mini-select"
                                    [ngModel]="r.type"
                                    (ngModelChange)="onRestrictionChange(i, ri, 'type', $event)">
                                    @for (opt of restrictionTypeOptions; track opt) {
                                      <option [value]="opt">{{ restrictionTypeDisplayMap[opt] }}</option>
                                    }
                                  </select>
                                  <input
                                    type="text" class="field-input rrr-mini-input"
                                    [ngModel]="r.description"
                                    (ngModelChange)="onRestrictionChange(i, ri, 'description', $event)"
                                    placeholder="Description" />
                                  <button class="rrr-remove-btn" (click)="removeRestriction(i, ri)" title="Remove">&times;</button>
                                </div>
                              }
                            } @else {
                              <p class="empty-message">No restrictions</p>
                            }
                          </div>

                          <!-- Responsibilities linked to this holder -->
                          <div class="rrr-sub-section">
                            <div class="rrr-sub-header">
                              <span class="rrr-sub-title">Responsibilities</span>
                              <button class="rrr-add-btn" (click)="addResponsibility(i)">+ Add</button>
                            </div>
                            @if (entry.responsibilities.length) {
                              @for (resp of entry.responsibilities; track resp.type; let rsi = $index) {
                                <div class="rrr-sub-row">
                                  <select
                                    class="field-select rrr-mini-select"
                                    [ngModel]="resp.type"
                                    (ngModelChange)="onResponsibilityChange(i, rsi, 'type', $event)">
                                    @for (opt of responsibilityTypeOptions; track opt) {
                                      <option [value]="opt">{{ responsibilityTypeDisplayMap[opt] }}</option>
                                    }
                                  </select>
                                  <input
                                    type="text" class="field-input rrr-mini-input"
                                    [ngModel]="resp.description"
                                    (ngModelChange)="onResponsibilityChange(i, rsi, 'description', $event)"
                                    placeholder="Description" />
                                  <button class="rrr-remove-btn" (click)="removeResponsibility(i, rsi)" title="Remove">&times;</button>
                                </div>
                              }
                            } @else {
                              <p class="empty-message">No responsibilities</p>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  }
                } @else {
                  <p class="empty-message">No RRR entries found</p>
                }
              </div>
            }

            <!-- ═══ Ownership Tab (editable table view) ═══ -->
            @if (activeRRRTab() === 'ownership') {
              <div class="tab-content">
                <div class="rrr-table-wrapper">
                  <table class="rrr-table">
                    <thead>
                      <tr>
                        <th>Right Holder</th>
                        <th>Type</th>
                        <th>Share</th>
                        <th>Temporal Validity</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      @if (buildingInfo()?.rrr?.entries?.length) {
                        @for (entry of buildingInfo()!.rrr.entries; track entry.rrrId; let i = $index) {
                          <tr class="rrr-data-row" (click)="toggleRRRExpand(entry.rrrId)">
                            <td>
                              <input
                                type="text" class="field-input rrr-cell-input"
                                [ngModel]="entry.holder"
                                (ngModelChange)="onRRRFieldChange(i, 'holder', $event)"
                                (click)="$event.stopPropagation()"
                                placeholder="Name" />
                            </td>
                            <td>
                              <select
                                class="field-select rrr-cell-select"
                                [ngModel]="entry.type"
                                (ngModelChange)="onRRRFieldChange(i, 'type', $event)"
                                (click)="$event.stopPropagation()">
                                @for (opt of rightTypeOptions; track opt) {
                                  <option [value]="opt">{{ rightTypeDisplayMap[opt] }}</option>
                                }
                              </select>
                            </td>
                            <td>
                              <input
                                type="number" class="field-input rrr-cell-input rrr-share-input"
                                [ngModel]="entry.share"
                                (ngModelChange)="onRRRFieldChange(i, 'share', $event)"
                                (click)="$event.stopPropagation()"
                                min="0" max="100" />
                            </td>
                            <td class="rrr-validity-cell">
                              <input
                                type="date" class="field-input rrr-cell-input"
                                [ngModel]="entry.validFrom"
                                (ngModelChange)="onRRRFieldChange(i, 'validFrom', $event)"
                                (click)="$event.stopPropagation()" />
                              <span class="rrr-validity-sep">&ndash;</span>
                              <input
                                type="date" class="field-input rrr-cell-input"
                                [ngModel]="entry.validTo"
                                (ngModelChange)="onRRRFieldChange(i, 'validTo', $event)"
                                (click)="$event.stopPropagation()"
                                placeholder="Indefinite" />
                            </td>
                            <td>
                              <button class="rrr-remove-btn" (click)="removeRRREntry(i); $event.stopPropagation()" title="Delete entry">&times;</button>
                            </td>
                          </tr>
                          <!-- Expanded detail row for document ref -->
                          @if (expandedRRRId() === entry.rrrId) {
                            <tr class="rrr-detail-row">
                              <td colspan="5">
                                <div class="rrr-detail-inline">
                                  <div class="rrr-inline-field">
                                    <span class="label">RRR ID:</span>
                                    <input type="text" class="field-input" [ngModel]="entry.rrrId"
                                      (ngModelChange)="onRRRFieldChange(i, 'rrrId', $event)" />
                                  </div>
                                  <div class="rrr-inline-field">
                                    <span class="label">Document Ref:</span>
                                    <input type="text" class="field-input" [ngModel]="entry.documentRef"
                                      (ngModelChange)="onRRRFieldChange(i, 'documentRef', $event)"
                                      placeholder="Path to deed/contract PDF" />
                                  </div>
                                </div>
                              </td>
                            </tr>
                          }
                        }
                      } @else {
                        <tr><td colspan="5" class="empty-message">No entries</td></tr>
                      }
                    </tbody>
                  </table>
                </div>
                <button class="rrr-add-entry-btn" (click)="addRRREntry()">+ Add Right / Tenure</button>
              </div>
            }

          </div>
        }
      </div>

      <!-- Restrictions Section (standalone) -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('restrictions')"
          (click)="toggleSection('restrictions')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
            </svg>
          </span>
          <span class="section-title">Restrictions</span>
          <span class="unit-count">{{ getAllRestrictions().length }}</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('restrictions')) {
          <div class="section-content">
            <div class="rrr-table-wrapper">
              <table class="rrr-table">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Holder</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  @if (getAllRestrictions().length) {
                    @for (item of getAllRestrictions(); track item.entryIndex + '-' + item.restrictionIndex) {
                      <tr>
                        <td>
                          <select
                            class="field-select rrr-cell-select"
                            [ngModel]="item.restriction.type"
                            (ngModelChange)="onRestrictionChange(item.entryIndex, item.restrictionIndex, 'type', $event)">
                            @for (opt of restrictionTypeOptions; track opt) {
                              <option [value]="opt">{{ restrictionTypeDisplayMap[opt] }}</option>
                            }
                          </select>
                        </td>
                        <td>
                          <input
                            type="text" class="field-input rrr-cell-input"
                            [ngModel]="item.restriction.description"
                            (ngModelChange)="onRestrictionChange(item.entryIndex, item.restrictionIndex, 'description', $event)"
                            placeholder="Description" />
                        </td>
                        <td class="rrr-holder-cell">{{ item.holder || '—' }}</td>
                        <td>
                          <button class="rrr-remove-btn" (click)="removeRestriction(item.entryIndex, item.restrictionIndex)" title="Delete">&times;</button>
                        </td>
                      </tr>
                    }
                  } @else {
                    <tr><td colspan="4" class="empty-message">No restrictions</td></tr>
                  }
                </tbody>
              </table>
            </div>
            <button class="rrr-add-entry-btn" (click)="addStandaloneRestriction()">+ Add Restriction</button>
          </div>
        }
      </div>

      <!-- Responsibilities Section (standalone) -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('responsibilities')"
          (click)="toggleSection('responsibilities')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <polyline points="17 11 19 13 23 9"/>
            </svg>
          </span>
          <span class="section-title">Responsibilities</span>
          <span class="unit-count">{{ getAllResponsibilities().length }}</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('responsibilities')) {
          <div class="section-content">
            <div class="rrr-table-wrapper">
              <table class="rrr-table">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Holder</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  @if (getAllResponsibilities().length) {
                    @for (item of getAllResponsibilities(); track item.entryIndex + '-' + item.responsibilityIndex) {
                      <tr>
                        <td>
                          <select
                            class="field-select rrr-cell-select"
                            [ngModel]="item.responsibility.type"
                            (ngModelChange)="onResponsibilityChange(item.entryIndex, item.responsibilityIndex, 'type', $event)">
                            @for (opt of responsibilityTypeOptions; track opt) {
                              <option [value]="opt">{{ responsibilityTypeDisplayMap[opt] }}</option>
                            }
                          </select>
                        </td>
                        <td>
                          <input
                            type="text" class="field-input rrr-cell-input"
                            [ngModel]="item.responsibility.description"
                            (ngModelChange)="onResponsibilityChange(item.entryIndex, item.responsibilityIndex, 'description', $event)"
                            placeholder="Description" />
                        </td>
                        <td class="rrr-holder-cell">{{ item.holder || '—' }}</td>
                        <td>
                          <button class="rrr-remove-btn" (click)="removeResponsibility(item.entryIndex, item.responsibilityIndex)" title="Delete">&times;</button>
                        </td>
                      </tr>
                    }
                  } @else {
                    <tr><td colspan="4" class="empty-message">No responsibilities</td></tr>
                  }
                </tbody>
              </table>
            </div>
            <button class="rrr-add-entry-btn" (click)="addStandaloneResponsibility()">+ Add Responsibility</button>
          </div>
        }
      </div>

      <!-- Building Units / Strata Section -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('units')"
          (click)="toggleSection('units')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
            </svg>
          </span>
          <span class="section-title">Building Units / Strata</span>
          <span class="unit-count">{{ buildingInfo()?.units?.length || 0 }}</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('units')) {
          <div class="section-content">
            <button class="explode-btn" (click)="onExplodeView()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
              </svg>
              Explode View
            </button>

            <div class="units-list">
              @if (buildingInfo()?.units?.length) {
                @for (unit of buildingInfo()?.units; track unit.unitId) {
                  <button
                    class="unit-item"
                    [class.selected]="selectedUnit()?.unitId === unit.unitId"
                    (click)="selectUnit(unit)">
                    <div class="unit-main">
                      <span class="unit-id">{{ unit.unitId }}</span>
                      <span class="unit-type">{{ unit.unitType }}</span>
                    </div>
                    <div class="unit-meta">
                      <span class="unit-floor">Floor {{ unit.floor }}</span>
                      <span class="unit-status" [class]="getStatusClass(unit.status)">
                        {{ unit.status }}
                      </span>
                    </div>
                  </button>
                }
              } @else {
                <p class="empty-message">No units defined</p>
              }
            </div>

            <!-- Selected Unit Details -->
            @if (selectedUnit()) {
              <div class="unit-details">
                <h4>Unit Details</h4>
                <table class="info-table compact">
                  <tr>
                    <td class="label">Unit ID</td>
                    <td class="value">{{ selectedUnit()?.unitId }}</td>
                  </tr>
                  <tr>
                    <td class="label">Type</td>
                    <td class="value">{{ selectedUnit()?.unitType }}</td>
                  </tr>
                  <tr>
                    <td class="label">Floor</td>
                    <td class="value">{{ selectedUnit()?.floor }}</td>
                  </tr>
                  <tr>
                    <td class="label">Area</td>
                    <td class="value">{{ formatArea(selectedUnit()?.area) }}</td>
                  </tr>
                  <tr>
                    <td class="label">Status</td>
                    <td class="value">
                      <span class="badge" [class]="getStatusClass(selectedUnit()?.status || '')">
                        {{ selectedUnit()?.status }}
                      </span>
                    </td>
                  </tr>
                  @if (selectedUnit()?.ownerName) {
                    <tr>
                      <td class="label">Owner</td>
                      <td class="value">{{ selectedUnit()?.ownerName }}</td>
                    </tr>
                  }
                </table>
              </div>
            }
          </div>
        }
      </div>

      <!-- Physical Attributes Section -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('physical')"
          (click)="toggleSection('physical')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
          </span>
          <span class="section-title">Physical Attributes</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('physical')) {
          <div class="section-content">
            <table class="info-table">
              <tr>
                <td class="label">Building Function</td>
                <td class="value">{{ buildingInfo()?.physicalAttributes?.buildingFunction || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">Number of Floors</td>
                <td class="value">{{ buildingInfo()?.physicalAttributes?.numberOfFloors || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">Gross Floor Area</td>
                <td class="value">{{ formatArea(buildingInfo()?.physicalAttributes?.grossFloorArea) }}</td>
              </tr>
              <tr>
                <td class="label">Construction Year</td>
                <td class="value">{{ buildingInfo()?.physicalAttributes?.constructionYear || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">Roof Type</td>
                <td class="value">{{ buildingInfo()?.physicalAttributes?.roofType || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">Wall Material</td>
                <td class="value">{{ buildingInfo()?.physicalAttributes?.wallMaterial || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">Foundation Type</td>
                <td class="value">{{ buildingInfo()?.physicalAttributes?.foundationType || 'N/A' }}</td>
              </tr>
              @if (buildingInfo()?.physicalAttributes?.energyRating) {
                <tr>
                  <td class="label">Energy Rating</td>
                  <td class="value">
                    <span class="badge badge-success">{{ buildingInfo()?.physicalAttributes?.energyRating }}</span>
                  </td>
                </tr>
              }
            </table>
          </div>
        }
      </div>

      <!-- Relationships & Topology Section -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('relationships')"
          (click)="toggleSection('relationships')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="18" cy="5" r="3"/>
              <circle cx="6" cy="12" r="3"/>
              <circle cx="18" cy="19" r="3"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
          </span>
          <span class="section-title">Relationships & Topology</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('relationships')) {
          <div class="section-content">
            <table class="info-table">
              <tr>
                <td class="label">parcelRelation</td>
                <td class="value">{{ buildingInfo()?.relationshipsTopology?.parcelRelation || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">adjacentBuildings</td>
                <td class="value">{{ buildingInfo()?.relationshipsTopology?.adjacentBuildings || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">sharedBoundaries</td>
                <td class="value">{{ buildingInfo()?.relationshipsTopology?.sharedBoundaries || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">partOfComplex</td>
                <td class="value">{{ buildingInfo()?.relationshipsTopology?.partOfComplex || 'N/A' }}</td>
              </tr>
            </table>
          </div>
        }
      </div>

      <!-- Metadata & Quality Section -->
      <div class="collapsible-section">
        <button
          class="section-header"
          [class.expanded]="isSectionExpanded('metadata')"
          (click)="toggleSection('metadata')">
          <span class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
          </span>
          <span class="section-title">Metadata & Quality</span>
          <span class="chevron">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>
        @if (isSectionExpanded('metadata')) {
          <div class="section-content">
            <table class="info-table">
              <tr>
                <td class="label">accuracyLevel</td>
                <td class="value">{{ buildingInfo()?.metadataQuality?.accuracyLevel || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">surveyMethod</td>
                <td class="value">{{ buildingInfo()?.metadataQuality?.surveyMethod || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">lastUpdated</td>
                <td class="value">{{ buildingInfo()?.metadataQuality?.lastUpdated || 'N/A' }}</td>
              </tr>
              <tr>
                <td class="label">responsibleParty</td>
                <td class="value">{{ buildingInfo()?.metadataQuality?.responsibleParty || 'N/A' }}</td>
              </tr>
            </table>
          </div>
        }
      </div>

      <!-- Tax & Valuation Section (only if data exists) -->
      @if (buildingInfo()?.taxValuation) {
        <div class="collapsible-section">
          <button
            class="section-header"
            [class.expanded]="false"
            (click)="toggleSection('physical')">
            <span class="section-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
            </span>
            <span class="section-title">Tax & Valuation</span>
            <span class="chevron">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </span>
          </button>
          <div class="section-content">
            <table class="info-table">
              <tr>
                <td class="label">Assessed Value</td>
                <td class="value">{{ formatCurrency(buildingInfo()?.taxValuation?.assessedValue) }}</td>
              </tr>
              <tr>
                <td class="label">Market Value</td>
                <td class="value">{{ formatCurrency(buildingInfo()?.taxValuation?.marketValue) }}</td>
              </tr>
              <tr>
                <td class="label">Annual Tax</td>
                <td class="value">{{ formatCurrency(buildingInfo()?.taxValuation?.annualTax) }}</td>
              </tr>
              <tr>
                <td class="label">Last Assessment</td>
                <td class="value">{{ buildingInfo()?.taxValuation?.lastAssessmentDate }}</td>
              </tr>
              <tr>
                <td class="label">Tax Status</td>
                <td class="value">
                  <span class="badge" [class.badge-success]="buildingInfo()?.taxValuation?.taxStatus === 'paid'"
                        [class.badge-warning]="buildingInfo()?.taxValuation?.taxStatus === 'pending'"
                        [class.badge-error]="buildingInfo()?.taxValuation?.taxStatus === 'overdue'">
                    {{ buildingInfo()?.taxValuation?.taxStatus }}
                  </span>
                </td>
              </tr>
            </table>
          </div>
        </div>
      }
    </div>
  }
</div>
